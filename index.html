<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quick Chat</title>
<style>
  /* Reset & basics */
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #eceef0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    color: #222;
  }
  body.night {
    background: #222;
    color: #ddd;
  }
  header {
    background: #0078d7;
    color: white;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 {
    margin: 0;
    font-size: 1.5em;
  }
  #changeUserBtn, #nightModeBtn, #avatarPickerBtn {
    background: white;
    border: none;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
    margin-left: 8px;
    font-weight: bold;
    color: #0078d7;
  }
  #changeUserBtn:hover, #nightModeBtn:hover, #avatarPickerBtn:hover {
    background: #cce4ff;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: #fff;
  }
  body.night #messages {
    background: #333;
  }
  .message {
    display: flex;
    gap: 10px;
    outline: none;
  }
  .message.you {
    flex-direction: row-reverse;
  }
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    position: relative;
  }
  .presence-online::after {
    content: "";
    position: absolute;
    bottom: 0;
    right: 0;
    width: 11px;
    height: 11px;
    background: #28a745;
    border: 2px solid white;
    border-radius: 50%;
  }
  .presence-offline::after {
    content: "";
    position: absolute;
    bottom: 0;
    right: 0;
    width: 11px;
    height: 11px;
    background: #aaa;
    border: 2px solid white;
    border-radius: 50%;
  }
  .message-content {
    max-width: 70%;
    display: flex;
    flex-direction: column;
  }
  .sender {
    font-weight: bold;
    font-size: 0.9em;
    margin-bottom: 3px;
  }
  .bubble {
    background: #0078d7;
    color: white;
    border-radius: 10px;
    padding: 8px 12px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  body.night .bubble {
    background: #005a9e;
  }
  .message.you .bubble {
    background: #28a745;
  }
  body.night .message.you .bubble {
    background: #19692c;
  }
  .info {
    font-size: 0.7em;
    color: #ccc;
    margin-top: 3px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .actions button {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.1em;
    margin-left: 5px;
    color: #eee;
  }
  .actions button:hover {
    color: #ff4444;
  }

  /* Typing bubbles container */
  #typingIndicatorsContainer {
    padding: 5px 10px;
    min-height: 30px;
  }

  /* Typing bubble style */
  .typing-bubble {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
    padding: 6px 12px;
    background: #0078d7;
    color: white;
    border-radius: 18px;
    font-style: italic;
    font-size: 0.9em;
    user-select: none;
  }
  body.night .typing-bubble {
    background: #005a9e;
  }
  .typing-bubble .dots {
    display: inline-block;
    width: 24px;
    text-align: left;
  }
  .typing-bubble .dot {
    display: inline-block;
    width: 5px;
    height: 5px;
    margin: 0 2px;
    background: white;
    border-radius: 50%;
    opacity: 0.3;
    animation-name: blink;
    animation-duration: 1.4s;
    animation-iteration-count: infinite;
    animation-fill-mode: both;
  }
  .typing-bubble .dot:nth-child(1) {
    animation-delay: 0s;
  }
  .typing-bubble .dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  .typing-bubble .dot:nth-child(3) {
    animation-delay: 0.4s;
  }
  @keyframes blink {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
  }

  footer {
    padding: 10px 20px;
    background: #eee;
    display: flex;
    gap: 5px;
    align-items: center;
  }
  body.night footer {
    background: #222;
  }
  #text {
    flex: 1;
    padding: 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  body.night #text {
    background: #444;
    border: 1px solid #666;
    color: white;
  }
  button {
    cursor: pointer;
    border: none;
    background: #0078d7;
    color: white;
    border-radius: 4px;
    padding: 8px 12px;
    font-weight: bold;
  }
  button:hover {
    background: #005a9e;
  }
  #fileInput {
    display: none;
  }
  #emojiPicker {
    position: absolute;
    bottom: 50px;
    left: 20px;
    background: #fff;
    border: 1px solid #ccc;
    max-width: 300px;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    flex-wrap: wrap;
    padding: 5px;
    border-radius: 6px;
    z-index: 10;
  }
  body.night #emojiPicker {
    background: #333;
    border: 1px solid #555;
  }
  #emojiPicker span {
    cursor: pointer;
    font-size: 20px;
    margin: 2px 4px;
    user-select: none;
  }
  #emojiPicker span:hover, #emojiPicker span:focus {
    background: #0078d7;
    color: white;
    border-radius: 4px;
    outline: none;
  }

  /* Modal for profile */
  #modalOverlay, #avatarPickerOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right:0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #modalContent, #avatarPickerModal {
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
    max-width: 90%;
    box-sizing: border-box;
    outline: none;
  }
  body.night #modalContent, body.night #avatarPickerModal {
    background: #444;
    color: white;
  }
  #modalContent h2 {
    margin-top: 0;
  }
  #usernameInput {
    width: 100%;
    padding: 8px;
    font-size: 1em;
    margin-bottom: 15px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  body.night #usernameInput {
    background: #555;
    border: 1px solid #666;
    color: white;
  }
  #saveProfileBtn {
    width: 100%;
    padding: 10px;
    font-weight: bold;
  }
  /* Avatar picker */
  #avatarPickerModal h2 {
    margin: 0 0 10px 0;
    user-select: none;
    text-align: center;
  }
  .avatar-option {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin: 5px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.3s;
  }
  .avatar-option.selected {
    border-color: #0078d7;
  }
  .avatar-option:hover, .avatar-option:focus {
    border-color: #005a9e;
    outline: none;
  }
</style>
</head>
<body>

<header>
  <h1>Quick Chat</h1>
  <div>
    <button id="avatarPickerBtn" title="Pick Avatar" aria-label="Pick Avatar">Avatar</button>
    <button id="changeUserBtn" title="Change Username" aria-label="Change Username">Change User</button>
    <button id="nightModeBtn" title="Toggle Night Mode" aria-label="Toggle Night Mode">🌙</button>
  </div>
</header>

<div id="messages" tabindex="0" aria-live="polite" aria-label="Chat messages"></div>
<!-- Replaced single typing indicator with container for multiple bubbles -->
<div id="typingIndicatorsContainer" aria-live="polite" aria-atomic="true"></div>

<footer>
  <button id="fileBtn" title="Send File" aria-label="Send File">📎</button>
  <input type="file" id="fileInput" aria-label="File input" />
  <button id="emojiBtn" title="Emoji Picker" aria-label="Emoji Picker">😊</button>
  <input type="text" id="text" placeholder="Type a message..." autocomplete="off" aria-label="Message input" />
  <button id="sendBtn" title="Send Message" aria-label="Send Message">Send</button>
</footer>

<div id="emojiPicker" role="listbox" aria-label="Emoji picker"></div>

<!-- Profile Modal -->
<div id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div id="modalContent" tabindex="0">
    <h2 id="modalTitle">Enter Username</h2>
    <input type="text" id="usernameInput" aria-required="true" aria-describedby="modalTitle" />
    <button id="saveProfileBtn">Save</button>
  </div>
</div>

<!-- Avatar Picker Modal -->
<div id="avatarPickerOverlay" role="dialog" aria-modal="true" aria-labelledby="avatarPickerTitle">
  <div id="avatarPickerModal" tabindex="0"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getDatabase, ref, push, onChildAdded, get, set,
    remove, onValue, onDisconnect
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  // Firebase config (replace with your own!)
  const firebaseConfig = {
    apiKey: "AIzaSyCx_glObBqdqtOs64JhV3fyJW-q9DOqbl0",
    authDomain: "live-chat-app-5ea98.firebaseapp.com",
    databaseURL: "https://live-chat-app-5ea98-default-rtdb.firebaseio.com",
    projectId: "live-chat-app-5ea98",
    storageBucket: "live-chat-app-5ea98.appspot.com",
    messagingSenderId: "58710835031",
    appId: "1:58710835031:web:9248de0eba59c09c0fc812"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");
  const typingRef = ref(db, "typing");
  const presenceRef = ref(db, "presence");
  const connectedRef = ref(db, ".info/connected");

  // DOM elements
  const textInput = document.getElementById("text");
  const sendBtn = document.getElementById("sendBtn");
  const fileInput = document.getElementById("fileInput");
  const fileBtn = document.getElementById("fileBtn");
  const emojiBtn = document.getElementById("emojiBtn");
  const emojiPicker = document.getElementById("emojiPicker");
  const messagesDiv = document.getElementById("messages");
  const nightModeBtn = document.getElementById("nightModeBtn");
  const changeUserBtn = document.getElementById("changeUserBtn");
  const typingIndicatorsContainer = document.getElementById("typingIndicatorsContainer");
  const modalOverlay = document.getElementById("modalOverlay");
  const usernameInput = document.getElementById("usernameInput");
  const saveProfileBtn = document.getElementById("saveProfileBtn");
  const avatarPickerOverlay = document.getElementById("avatarPickerOverlay");
  const avatarPickerModal = document.getElementById("avatarPickerModal");
  const avatarPickerBtn = document.getElementById("avatarPickerBtn");

  // Globals
  let userId = localStorage.getItem("userId");
  if (!userId) {
    userId = "user_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("userId", userId);
  }
  let username = localStorage.getItem("username");
  let avatar = localStorage.getItem("avatar") || "";
  let typingTimeout;
  let isTyping = false;

  // Avatar list (example male avatars)
  const avatars = [
    "https://randomuser.me/api/portraits/men/11.jpg",
    "https://randomuser.me/api/portraits/men/12.jpg",
    "https://randomuser.me/api/portraits/men/13.jpg",
    "https://randomuser.me/api/portraits/men/14.jpg",
    "https://randomuser.me/api/portraits/men/15.jpg",
    "https://randomuser.me/api/portraits/men/16.jpg",
    "https://randomuser.me/api/portraits/men/17.jpg",
    "https://randomuser.me/api/portraits/men/18.jpg",
    "https://randomuser.me/api/portraits/men/19.jpg",
    "https://randomuser.me/api/portraits/men/20.jpg",
    "https://randomuser.me/api/portraits/men/21.jpg",
    "https://randomuser.me/api/portraits/men/22.jpg",
    "https://randomuser.me/api/portraits/men/23.jpg",
    "https://randomuser.me/api/portraits/men/24.jpg",
    "https://randomuser.me/api/portraits/men/25.jpg",
    "https://randomuser.me/api/portraits/men/26.jpg",
    "https://randomuser.me/api/portraits/men/27.jpg",
    "https://randomuser.me/api/portraits/men/28.jpg",
    "https://randomuser.me/api/portraits/men/29.jpg",
    "https://randomuser.me/api/portraits/men/30.jpg"
  ];

  // Emoji list
  const emojis = ["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😜","🤪","🤨","🧐","😎","🤓","🤑"];

  // --- Init night mode ---
  function loadNightMode() {
    if (localStorage.getItem("nightMode") === "true") {
      document.body.classList.add("night");
      nightModeBtn.textContent = "☀️";
    } else {
      document.body.classList.remove("night");
      nightModeBtn.textContent = "🌙";
    }
  }
  loadNightMode();

  nightModeBtn.onclick = () => {
    const isNight = document.body.classList.toggle("night");
    localStorage.setItem("nightMode", isNight);
    nightModeBtn.textContent = isNight ? "☀️" : "🌙";
  };

  // --- Show modal to set username if not set ---
  function showProfileModal() {
    modalOverlay.style.display = "flex";
    usernameInput.value = username || "";
    usernameInput.focus();
  }

  saveProfileBtn.onclick = () => {
    const val = usernameInput.value.trim();
    if (val.length < 2) {
      alert("Username must be at least 2 characters");
      return;
    }
    username = val;
    localStorage.setItem("username", username);
    modalOverlay.style.display = "none";
    updatePresence(true);
  };

  // --- Avatar picker modal ---
  avatarPickerBtn.onclick = () => {
    openAvatarPicker();
  };

  function openAvatarPicker() {
    avatarPickerOverlay.style.display = "flex";
    avatarPickerModal.innerHTML = "<h2 id='avatarPickerTitle'>Pick Your Avatar</h2>";
    const grid = document.createElement("div");
    grid.style.display = "flex";
    grid.style.flexWrap = "wrap";
    grid.style.justifyContent = "center";
    avatars.forEach((url) => {
      const img = document.createElement("img");
      img.src = url;
      img.alt = "Avatar option";
      img.tabIndex = 0;
      img.className = "avatar-option";
      if (url === avatar) img.classList.add("selected");
      img.onclick = () => {
        avatar = url;
        localStorage.setItem("avatar", avatar);
        closeAvatarPicker();
        // Update UI avatars immediately
        refreshAllMessages();
      };
      img.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          img.click();
        }
      };
      grid.appendChild(img);
    });
    avatarPickerModal.appendChild(grid);
    avatarPickerModal.focus();
  }

  function closeAvatarPicker() {
    avatarPickerOverlay.style.display = "none";
  }

  avatarPickerOverlay.onclick = (e) => {
    if (e.target === avatarPickerOverlay) closeAvatarPicker();
  };

  // --- Change User ---
  changeUserBtn.onclick = () => {
    showProfileModal();
  };

  // --- Emoji Picker ---
  emojiBtn.onclick = () => {
    if (emojiPicker.style.display === "flex") {
      emojiPicker.style.display = "none";
    } else {
      emojiPicker.innerHTML = "";
      emojis.forEach(e => {
        const span = document.createElement("span");
        span.textContent = e;
        span.tabIndex = 0;
        span.onclick = () => {
          textInput.value += e;
          textInput.focus();
          emojiPicker.style.display = "none";
          triggerTyping();
        };
        span.onkeydown = (ev) => {
          if(ev.key === "Enter" || ev.key === " ") {
            ev.preventDefault();
            span.click();
          }
        };
        emojiPicker.appendChild(span);
      });
      emojiPicker.style.display = "flex";
      emojiPicker.style.flexWrap = "wrap";
      emojiPicker.style.position = "absolute";
      emojiPicker.style.bottom = "60px";
      emojiPicker.style.left = "10px";
    }
  };

  document.addEventListener("click", e => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
      emojiPicker.style.display = "none";
    }
  });

  // --- Sending Messages ---
  sendBtn.onclick = sendMessage;
  textInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
    triggerTyping();
  });

  fileBtn.onclick = () => fileInput.click();

  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    // Just show a file name message for simplicity
    sendMessage(file.name, true);
    fileInput.value = "";
  };

  async function sendMessage(text, isFile = false) {
    if (!username) {
      alert("Please set your username first.");
      showProfileModal();
      return;
    }
    if (!text.trim()) return;

    const msgData = {
      userId,
      username,
      avatar,
      text: text.trim(),
      timestamp: Date.now(),
      isFile: !!isFile
    };
    try {
      await push(messagesRef, msgData);
      textInput.value = "";
      stopTyping();
    } catch (err) {
      console.error("Error sending message:", err);
    }
  }

  // --- Render messages ---
  function createMessageElement(data, key) {
    const msgDiv = document.createElement("div");
    msgDiv.className = "message" + (data.userId === userId ? " you" : "");
    msgDiv.tabIndex = 0;
    msgDiv.dataset.key = key;

    const avatarImg = document.createElement("img");
    avatarImg.className = "avatar";
    avatarImg.src = data.avatar || avatars[0];
    avatarImg.alt = `${data.username}'s avatar`;

    // presence dot - online/offline
    const userPresence = presenceStatus[data.userId];
    avatarImg.classList.remove("presence-online", "presence-offline");
    avatarImg.classList.add(userPresence === "online" ? "presence-online" : "presence-offline");

    msgDiv.appendChild(avatarImg);

    const contentDiv = document.createElement("div");
    contentDiv.className = "message-content";

    const senderDiv = document.createElement("div");
    senderDiv.className = "sender";
    senderDiv.textContent = data.username;
    contentDiv.appendChild(senderDiv);

    const bubbleDiv = document.createElement("div");
    bubbleDiv.className = "bubble";
    bubbleDiv.textContent = data.text;
    if (data.isFile) {
      bubbleDiv.style.fontStyle = "italic";
      bubbleDiv.textContent = "[File] " + data.text;
    }
    contentDiv.appendChild(bubbleDiv);

    // Timestamp
    const infoDiv = document.createElement("div");
    infoDiv.className = "info";
    const timeSpan = document.createElement("span");
    const date = new Date(data.timestamp);
    timeSpan.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    infoDiv.appendChild(timeSpan);

    // Edit/Delete actions if your own message
    if (data.userId === userId) {
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "actions";
      const delBtn = document.createElement("button");
      delBtn.title = "Delete message";
      delBtn.innerHTML = "🗑️";
      delBtn.onclick = () => {
        if (confirm("Delete this message?")) {
          remove(ref(db, "messages/" + key));
        }
      };
      actionsDiv.appendChild(delBtn);
      infoDiv.appendChild(actionsDiv);
    }

    contentDiv.appendChild(infoDiv);

    msgDiv.appendChild(contentDiv);

    return msgDiv;
  }

  function refreshAllMessages() {
    // Re-render all messages to update avatars or presence dots
    messagesDiv.innerHTML = "";
    for (const [key, data] of Object.entries(allMessages)) {
      const msgElem = createMessageElement(data, key);
      messagesDiv.appendChild(msgElem);
    }
    scrollToBottom();
  }

  // --- Message handling ---
  const allMessages = {};

  onChildAdded(messagesRef, snapshot => {
    const data = snapshot.val();
    const key = snapshot.key;
    allMessages[key] = data;
    const msgElem = createMessageElement(data, key);
    messagesDiv.appendChild(msgElem);
    scrollToBottom();
  });

  // --- Scroll to bottom ---
  function scrollToBottom() {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // --- Typing indicator ---

  // Save typing statuses as userId: username in typingRef
  textInput.addEventListener("input", () => {
    triggerTyping();
  });

  function triggerTyping() {
    if (!username) return;
    if (isTyping) {
      clearTimeout(typingTimeout);
    } else {
      isTyping = true;
      set(ref(db, "typing/" + userId), username).catch(() => {});
    }
    typingTimeout = setTimeout(() => {
      stopTyping();
    }, 2000);
  }

  function stopTyping() {
    isTyping = false;
    remove(ref(db, "typing/" + userId)).catch(() => {});
  }

  // Listen for typing changes, show a typing bubble per typing user except self
  onValue(typingRef, (snapshot) => {
    const val = snapshot.val() || {};
    const userTypingUsers = new Set();

    Object.entries(val).forEach(([id, name]) => {
      if (id !== userId && typeof name === "string") {
        userTypingUsers.add(name);
      }
    });

    renderTypingBubbles(userTypingUsers);
  });

  function renderTypingBubbles(usernames) {
    typingIndicatorsContainer.innerHTML = "";

    usernames.forEach(name => {
      const bubble = document.createElement("div");
      bubble.className = "typing-bubble";
      bubble.setAttribute("aria-live", "polite");
      bubble.setAttribute("role", "status");
      bubble.innerHTML = `
        👤 <strong>${escapeHTML(name)}</strong> is typing
        <span class="dots">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </span>`;
      typingIndicatorsContainer.appendChild(bubble);
    });
  }

  // --- Presence system ---
  const presenceStatus = {};

  connectedRef.onValue((snap) => {
    if (snap.val() === true) {
      const userPresenceRef = ref(db, `presence/${userId}`);
      set(userPresenceRef, "online");
      onDisconnect(userPresenceRef).set("offline");
    }
  });

  // Listen for presence changes
  onValue(ref(db, "presence"), (snap) => {
    const val = snap.val() || {};
    Object.entries(val).forEach(([id, status]) => {
      presenceStatus[id] = status;
    });
    // Update presence dots on all messages
    refreshAllMessages();
  });

  // --- Escape HTML utility ---
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, (m) => {
      switch (m) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#39;";
      }
    });
  }

  // --- Initialization ---
  function init() {
    if (!username) {
      showProfileModal();
    } else {
      updatePresence(true);
    }
    refreshAllMessages();
  }

  // --- Update presence online status ---
  function updatePresence(isOnline) {
    if (!userId) return;
    set(ref(db, `presence/${userId}`), isOnline ? "online" : "offline");
  }

  window.addEventListener("beforeunload", () => {
    updatePresence(false);
    stopTyping();
  });

  // --- Keyboard accessibility for modal ---
  modalOverlay.addEventListener("keydown", e => {
    if (e.key === "Escape") {
      modalOverlay.style.display = "none";
    }
  });

  avatarPickerOverlay.addEventListener("keydown", e => {
    if (e.key === "Escape") {
      closeAvatarPicker();
    }
  });

  // --- Start ---
  init();
</script>

</body>
</html>
