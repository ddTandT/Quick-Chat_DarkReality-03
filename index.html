<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick Chat</title>
  <style>
    /* === Your original styles unchanged, example: === */
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0; background: #f0f0f0;
    }
    .chat-container {
      max-width: 600px;
      margin: 20px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 80vh;
    }
    .chat-header {
      padding: 10px 15px;
      background: #0078d7;
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-buttons button {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f9f9f9;
    }
    .chat-input {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: #fafafa;
    }
    .chat-input input[type="text"] {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
    }
    .chat-input button {
      margin-left: 10px;
      background: #0078d7;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0 15px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .emoji-picker {
      position: absolute;
      bottom: 50px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      padding: 5px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      flex-wrap: wrap;
      z-index: 1000;
    }
    .emoji-picker span {
      font-size: 1.4rem;
      cursor: pointer;
      margin: 3px;
      user-select: none;
    }
    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 10px;
    }
    .message.you {
      flex-direction: row-reverse;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
      object-fit: cover;
      border: 2px solid transparent;
    }
    .presence-online {
      border-color: #4CAF50 !important;
      box-shadow: 0 0 5px #4CAF50;
    }
    .presence-offline {
      opacity: 0.5;
    }
    .presence-dot {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      background: #4CAF50;
    }
    .presence-dot.offline {
      background: #ccc;
    }
    .message-content {
      max-width: 70%;
    }
    .sender {
      font-weight: bold;
      margin-bottom: 3px;
      font-size: 0.9rem;
      color: #333;
    }
    .bubble {
      background: #e1e1e1;
      padding: 10px;
      border-radius: 12px;
      font-size: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .message.you .bubble {
      background: #0078d7;
      color: white;
    }
    #typingIndicator {
      font-style: italic;
      color: #666;
      height: 24px;
      margin-left: 15px;
      margin-bottom: 5px;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .modal {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .modal h2 {
      margin: 0 0 10px 0;
      font-weight: 700;
      font-size: 1.4rem;
      text-align: center;
    }
    .modal input[type="text"] {
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
    }
    .gender-options {
      display: flex;
      justify-content: space-around;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    .gender-options label {
      cursor: pointer;
    }
    .gender-options input[type="radio"] {
      margin-right: 5px;
    }
    .modal button {
      padding: 10px;
      background: #0078d7;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Avatar picker modal */
    #avatarPickerOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #avatarPickerModal {
      background: white;
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .avatar-option {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      object-fit: cover;
      transition: border-color 0.2s;
    }
    .avatar-option.selected {
      border-color: #0078d7;
    }
    .night {
      background: #1e1e1e;
      color: white;
    }
    .night .chat-header {
      background: #0e639c;
    }
    .night .chat-input {
      background: #252526;
      border-top: 1px solid #333;
    }
    .night .chat-messages {
      background: #252526;
    }
    .night .bubble {
      background: #333;
      color: #ddd;
    }
    .night .message.you .bubble {
      background: #0078d7;
      color: white;
    }
  </style>
</head>
<body>
  <div class="chat-container" role="main" aria-label="Chat Application">
    <div class="chat-header">
      <div class="title">Quick Chat</div>
      <div class="header-buttons">
        <button id="changeUserBtn" aria-label="Change User Profile">üë§</button>
        <button id="avatarPickerBtn" aria-label="Pick Avatar">üñºÔ∏è</button>
        <button id="nightModeBtn" aria-label="Toggle Night Mode">üåô</button>
      </div>
    </div>
    <div class="chat-messages" id="messages" tabindex="0" aria-live="polite" aria-atomic="false"></div>
    <div id="typingIndicator" aria-live="polite" aria-atomic="true"></div>
    <div class="chat-input" role="form" aria-label="Send message form">
      <input id="text" type="text" placeholder="Type a message‚Ä¶" autocomplete="off" aria-label="Message input" />
      <button id="emojiBtn" aria-label="Open emoji picker">üòä</button>
      <input type="file" id="fileInput" accept="image/*" style="display:none" aria-hidden="true" />
      <button id="fileBtn" aria-label="Attach image">üìé</button>
      <button id="sendBtn" aria-label="Send message">‚û§</button>
    </div>
    <div class="emoji-picker" id="emojiPicker" role="list" aria-label="Emoji picker"></div>
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal" role="document">
      <h2 id="modalTitle">Set Your Profile</h2>
      <label for="usernameInput">Name:</label>
      <input type="text" id="usernameInput" maxlength="30" autocomplete="off" />
      <label>Gender:</label>
      <div class="gender-options">
        <label><input type="radio" name="gender" value="male" checked /> Male</label>
        <!-- Female disabled as per request -->
      </div>
      <button id="saveProfileBtn">Save</button>
    </div>
  </div>

  <!-- Avatar Picker Modal -->
  <div id="avatarPickerOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="avatarPickerTitle">
    <div id="avatarPickerModal" tabindex="0" role="document">
      <h2 id="avatarPickerTitle">Pick Your Avatar</h2>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, onValue,
      set, remove, onDisconnect, get
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCx_glObBqdqtOs64JhV3fyJW-q9DOqbl0",
      authDomain: "live-chat-app-5ea98.firebaseapp.com",
      databaseURL: "https://live-chat-app-5ea98-default-rtdb.firebaseio.com",
      projectId: "live-chat-app-5ea98",
      storageBucket: "live-chat-app-5ea98.firebasestorage.app",
      messagingSenderId: "58710835031",
      appId: "1:58710835031:web:9248de0eba59c09c0fc812",
      measurementId: "G-M7BMS3FS2L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages");
    const typingRef = ref(db, "typing");
    const presenceRef = ref(db, "presence");

    // 20+ male avatars reliable URLs from Unsplash, man portraits (must be CORS allowed)
    const maleAvatars = [
      "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1527980965255-d3b416303d12?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1508214751197-bcfd4ca60f92?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1492562080023-ab3db95bfbce?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1544005313-94ddf0286df2?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1552058544-f2b08422138a?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1488426862026-3ee34a7d66df?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1508214751198-bcfd4ca60f93?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1492562080024-ab3db95bfbcf?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1508214751199-bcfd4ca60f94?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1546525848-3ce03ca516f6?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1546508295-50ef489440af?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1508214751200-bcfd4ca60f95?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1527980965256-d3b416303d13?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1508214751201-bcfd4ca60f96?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1494790108378-be9c29b29331?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1508214751202-bcfd4ca60f97?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80",
      "https://images.unsplash.com/photo-1492562080025-ab3db95bfbce?ixlib=rb-4.0.3&auto=format&fit=crop&w=64&q=80"
    ];

    // Long emoji list
    const emojiList = [
      "üòÄ","üòÅ","üòÇ","ü§£","üòÉ","üòÑ","üòÖ","üòÜ","üòâ","üòä","üòã","üòé","üòç","üòò","üòó","üòô","üòö",
      "üôÇ","ü§ó","ü§©","ü§î","ü§®","üòê","üòë","üò∂","üôÑ","üòè","üò£","üò•","üòÆ","ü§ê","üòØ","üò™","üò´",
      "üò¥","üòå","üòõ","üòú","üòù","ü§§","üòí","üòì","üòî","üòï","üôÉ","ü§ë","üò≤","‚òπÔ∏è","üôÅ","üòñ","üòû",
      "üòü","üò§","üò¢","üò≠","üò¶","üòß","üò®","üò©","ü§Ø","üò¨","üò∞","üò±","ü•µ","ü•∂","üò≥","ü§™","üòµ",
      "üò°","üò†","ü§¨","üò∑","ü§í","ü§ï","ü§¢","ü§Æ","ü§ß","üòá","ü§†","ü•≥","ü•¥","ü•∫","ü§•","ü§´","ü§≠",
      "üßê","ü§ì","üòà","üëø","üëπ","üë∫","üíÄ","üëª","üëΩ","ü§ñ","üí©","üò∫","üò∏","üòπ","üòª","üòº","üòΩ",
      "üôÄ","üòø","üòæ"
    ];

    // UI references
    const ui = {
      messages: document.getElementById("messages"),
      typingIndicator: document.getElementById("typingIndicator"),
      text: document.getElementById("text"),
      emojiBtn: document.getElementById("emojiBtn"),
      emojiPicker: document.getElementById("emojiPicker"),
      fileBtn: document.getElementById("fileBtn"),
      fileInput: document.getElementById("fileInput"),
      sendBtn: document.getElementById("sendBtn"),
      avatarBtn: document.getElementById("avatarPickerBtn"),
      changeUserBtn: document.getElementById("changeUserBtn"),
      saveProfileBtn: document.getElementById("saveProfileBtn"),
      usernameInput: document.getElementById("usernameInput"),
      modalOverlay: document.getElementById("modalOverlay"),
      avatarOverlay: document.getElementById("avatarPickerOverlay"),
      avatarModal: document.getElementById("avatarPickerModal"),
      nightBtn: document.getElementById("nightModeBtn")
    };

    let currentUser = null;
    let isTyping = false;
    let typingTimeout;
    const onlineUsers = new Map();

    // Helpers
    function sanitizeKey(name) {
      return name.replace(/\W/g, "_");
    }

    function loadUser() {
      try {
        const user = JSON.parse(localStorage.getItem("quickchat_user"));
        if (user && user.username && user.avatar && user.gender) return user;
      } catch {}
      return null;
    }

    function saveUser() {
      localStorage.setItem("quickchat_user", JSON.stringify(currentUser));
    }

    function showModal() {
      ui.modalOverlay.style.display = "flex";
      ui.usernameInput.value = currentUser?.username || "";
      ui.usernameInput.focus();
    }

    function hideModal() {
      ui.modalOverlay.style.display = "none";
    }

    function showAvatarPicker() {
      if (!currentUser) {
        showModal();
        return;
      }
      ui.avatarOverlay.style.display = "flex";
      ui.avatarModal.innerHTML = '<h2 id="avatarPickerTitle">Pick Your Avatar</h2>';
      maleAvatars.forEach((url) => {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Avatar";
        img.className = "avatar-option";
        if (currentUser.avatar === url) img.classList.add("selected");
        img.addEventListener("click", () => {
          currentUser.avatar = url;
          saveUser();
          updatePresence();
          ui.avatarOverlay.style.display = "none";
          reloadMessages();
        });
        ui.avatarModal.append(img);
      });
    }

    ui.avatarOverlay.addEventListener("click", (e) => {
      if (e.target === ui.avatarOverlay) ui.avatarOverlay.style.display = "none";
    });

    ui.changeUserBtn.addEventListener("click", showModal);

    ui.saveProfileBtn.addEventListener("click", () => {
      const name = ui.usernameInput.value.trim();
      const gender = "male"; // Female disabled
      if (!name) {
        alert("Please enter a name.");
        return;
      }
      if (!currentUser || currentUser.username !== name) {
        // Assign avatar deterministically
        const avatarIndex = Math.abs(
          [...name].map((c) => c.charCodeAt(0)).reduce((a, b) => a + b, 0) % maleAvatars.length
        );
        currentUser = { username: name, gender, avatar: maleAvatars[avatarIndex] };
      } else {
        currentUser.username = name;
        currentUser.gender = gender;
      }
      saveUser();
      hideModal();
      initPresence();
      loadMessages();
    });

    ui.avatarBtn.addEventListener("click", showAvatarPicker);

    // Night mode toggle and persistence
    ui.nightBtn.addEventListener("click", () => {
      document.body.classList.toggle("night");
      localStorage.setItem("nightmode", document.body.classList.contains("night"));
    });
    if (localStorage.getItem("nightmode") === "true") {
      document.body.classList.add("night");
    }

    // Emoji picker setup
    ui.emojiBtn.addEventListener("click", () => {
      const picker = ui.emojiPicker;
      if (picker.style.display === "flex") {
        picker.style.display = "none";
        return;
      }
      picker.innerHTML = "";
      emojiList.forEach((emoji) => {
        const span = document.createElement("span");
        span.textContent = emoji;
        span.setAttribute("role", "option");
        span.tabIndex = 0;
        span.addEventListener("click", () => {
          insertAtCursor(ui.text, emoji);
          ui.text.focus();
          picker.style.display = "none";
        });
        picker.appendChild(span);
      });
      picker.style.display = "flex";
    });

    // Close emoji picker when clicking outside
    document.body.addEventListener("click", (e) => {
      if (!ui.emojiPicker.contains(e.target) && e.target !== ui.emojiBtn) {
        ui.emojiPicker.style.display = "none";
      }
    });

    function insertAtCursor(input, textToInsert) {
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value =
        input.value.substring(0, start) +
        textToInsert +
        input.value.substring(end);
      input.selectionStart = input.selectionEnd = start + textToInsert.length;
    }

    // Typing indicator logic
    ui.text.addEventListener("input", () => {
      if (!currentUser) return;
      if (!isTyping) {
        isTyping = true;
        set(ref(db, `typing/${sanitizeKey(currentUser.username)}`), currentUser.username);
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        isTyping = false;
        remove(ref(db, `typing/${sanitizeKey(currentUser.username)}`));
      }, 2000);
    });

    // Show typing indicator for others only, show username who is typing
    onValue(typingRef, (snap) => {
      const typingUsers = snap.val() || {};
      const othersTyping = Object.values(typingUsers).filter(
        (name) => name !== currentUser?.username
      );
      if (othersTyping.length > 0) {
        ui.typingIndicator.textContent =
          othersTyping.length === 1
            ? `${othersTyping[0]} is typing...`
            : `${othersTyping.join(", ")} are typing...`;
      } else {
        ui.typingIndicator.textContent = "";
      }
    });

    // Presence system (online/offline)
    function initPresence() {
      if (!currentUser) return;
      const key = sanitizeKey(currentUser.username);
      const userPresenceRef = ref(db, `presence/${key}`);
      set(userPresenceRef, { ...currentUser, online: true });
      onDisconnect(userPresenceRef).remove();

      // update presence every 15s to keep alive
      setInterval(() => {
        set(userPresenceRef, { ...currentUser, online: true });
      }, 15000);
    }

    onValue(presenceRef, (snap) => {
      const data = snap.val() || {};
      onlineUsers.clear();
      Object.entries(data).forEach(([key, user]) => {
        if (user.online) onlineUsers.set(key, user);
      });
      updatePresence();
    });

    function updatePresence() {
      document.querySelectorAll(".message").forEach((el) => {
        const sender = el.querySelector(".sender")?.textContent;
        const avatarImg = el.querySelector(".avatar");
        if (!sender || !avatarImg) return;
        const key = sanitizeKey(sender);
        if (onlineUsers.has(key)) {
          avatarImg.classList.add("presence-online");
          avatarImg.classList.remove("presence-offline");
        } else {
          avatarImg.classList.remove("presence-online");
          avatarImg.classList.add("presence-offline");
        }
      });
    }

    // Sending messages
    function sendMessage(content, type = "text") {
      if (!currentUser || !content.trim()) return;
      const message = {
        username: currentUser.username,
        avatar: currentUser.avatar,
        content: content.trim(),
        type,
        timestamp: Date.now(),
      };
      push(messagesRef, message);
      ui.text.value = "";
      isTyping = false;
      remove(ref(db, `typing/${sanitizeKey(currentUser.username)}`));
    }

    ui.sendBtn.addEventListener("click", () => {
      sendMessage(ui.text.value);
    });

    ui.text.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage(ui.text.value);
      }
    });

    ui.fileBtn.addEventListener("click", () => ui.fileInput.click());

    ui.fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        alert("Only image files are allowed!");
        ui.fileInput.value = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        sendMessage(reader.result, "image");
      };
      reader.readAsDataURL(file);
      ui.fileInput.value = "";
    });

    // Render messages
    function createMessageElement(msg) {
      const div = document.createElement("div");
      div.className = "message";
      if (currentUser && msg.username === currentUser.username) div.classList.add("you");

      const avatar = document.createElement("img");
      avatar.src = msg.avatar || maleAvatars[0];
      avatar.alt = "Avatar";
      avatar.className = "avatar";

      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";

      const senderDiv = document.createElement("div");
      senderDiv.className = "sender";
      senderDiv.textContent = msg.username;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if (msg.type === "image") {
        const img = document.createElement("img");
        img.src = msg.content;
        img.alt = "Sent image";
        img.style.maxWidth = "200px";
        img.style.borderRadius = "8px";
        bubble.appendChild(img);
      } else {
        bubble.textContent = msg.content;
      }

      contentDiv.appendChild(senderDiv);
      contentDiv.appendChild(bubble);

      div.appendChild(avatar);
      div.appendChild(contentDiv);
      return div;
    }

    function loadMessages() {
      ui.messages.innerHTML = "";
      get(messagesRef).then((snap) => {
        if (!snap.exists()) return;
        const messages = Object.values(snap.val());
        messages.sort((a, b) => a.timestamp - b.timestamp);
        messages.forEach((msg) => {
          ui.messages.appendChild(createMessageElement(msg));
        });
        updatePresence();
        ui.messages.scrollTop = ui.messages.scrollHeight;
      });
    }

    onChildAdded(messagesRef, (snap) => {
      const msg = snap.val();
      ui.messages.appendChild(createMessageElement(msg));
      updatePresence();
      ui.messages.scrollTop = ui.messages.scrollHeight;
    });

    function reloadMessages() {
      loadMessages();
    }

    window.addEventListener("beforeunload", () => {
      isTyping = false;
      if (currentUser) {
        remove(ref(db, `typing/${sanitizeKey(currentUser.username)}`));
        set(ref(db, `presence/${sanitizeKey(currentUser.username)}`), {
          ...currentUser,
          online: false,
        });
      }
    });

    // Initial setup
    currentUser = loadUser();
    if (!currentUser) {
      showModal();
    } else {
      initPresence();
      loadMessages();
    }
  </script>
</body>
</html>
