<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick Chat</title>
  <style>
    /* Existing styles unchanged */
    body {
      margin: 0;
      font-family: 'Segoe UI','Helvetica Neue',Arial,sans-serif;
      background: #eceef0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s;
    }
    body.night {
      background: #18191a;
    }
    .chat-container {
      width: 100%; max-width: 380px;
      height: 600px;
      background: #ffffff;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      position: relative;
    }
    body.night .chat-container {
      background: #242526;
      box-shadow: 0 2px 12px rgba(255,255,255,0.1);
    }
    .chat-header {
      background: #0084ff;
      color: white;
      padding: 12px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .chat-header .title {
      font-size: 1rem;
      flex-grow: 1;
    }
    .chat-header .header-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chat-header button {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      color: white;
      cursor: pointer;
      padding: 0 6px;
      user-select: none;
    }
    .chat-messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background: #f0f2f5;
    }
    body.night .chat-messages {
      background: #3a3b3c;
    }
    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 14px;
      max-width: 100%;
    }
    .message.you {
      flex-direction: row-reverse;
      text-align: right;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin: 0 8px;
      object-fit: cover;
      flex-shrink: 0;
      position: relative;
      cursor: default;
    }
    /* Presence dot on avatar */
    .avatar.presence-online::after {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 10px;
      height: 10px;
      background: #4caf50;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 0 4px #4caf50;
    }
    .message-content {
      max-width: 70%;
      display: flex;
      flex-direction: column;
    }
    .sender {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 2px;
      user-select: text;
    }
    body.night .sender {
      color: #aaa;
    }
    .bubble {
      background: #0084ff;
      color: white;
      padding: 8px 12px;
      border-radius: 18px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .message.you .bubble {
      background: #dcf8c6;
      color: #050505;
    }
    body.night .bubble {
      background: #4b4b4b;
      color: #e4e6eb;
    }
    .info {
      font-size: 0.7rem;
      color: #555;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    body.night .info {
      color: #aaa;
    }
    .info .actions {
      display: none;
      gap: 8px;
      cursor: pointer;
    }
    .message-content:hover .actions {
      display: inline-flex;
    }
    .info .actions button {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1rem;
      cursor: pointer;
      padding: 0 3px;
      user-select: none;
    }
    .chat-input {
      padding: 10px;
      background: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    body.night .chat-input {
      background: #242526;
    }
    .chat-input input[type="text"] {
      flex: 1;
      border: none;
      padding: 8px 12px;
      border-radius: 18px;
      background: #f0f2f5;
      outline: none;
      font-size: 1rem;
      color: #000;
      resize: none;
      max-height: 80px;
    }
    body.night .chat-input input[type="text"] {
      background: #3a3b3c;
      color: #e4e6eb;
    }
    .chat-input button {
      background: #0084ff;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 1rem;
      user-select: none;
    }
    body.night .chat-input button {
      background: #1877f2;
    }
    .emoji-picker {
      position: absolute;
      bottom: 60px;
      right: 60px;
      background: #ffffff;
      border-radius: 8px;
      padding: 8px;
      display: none;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 6px;
      z-index: 10;
    }
    body.night .emoji-picker {
      background: #3a3b3c;
    }
    .emoji-picker span {
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      user-select: none;
    }
    .emoji-picker span:hover {
      background: #0084ff;
      color: white;
    }
    /* Modal for changing username/gender */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      color: #000;
      max-height: 90vh;
      overflow-y: auto;
    }
    body.night .modal {
      background: #3a3b3c;
      color: #e4e6eb;
    }
    .modal h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .modal label {
      display: block;
      margin-bottom: 6px;
      user-select: none;
    }
    .modal input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 12px;
      font-size: 1rem;
      color: #000;
    }
    body.night .modal input[type="text"] {
      background: #555;
      border: 1px solid #777;
      color: #e4e6eb;
    }
    .gender-options {
      display: flex;
      gap: 15px;
      margin-bottom: 12px;
    }
    .gender-options label {
      cursor: pointer;
      user-select: none;
    }
    .modal button {
      background: #0084ff;
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      user-select: none;
    }
    body.night .modal button {
      background: #1877f2;
    }
    /* Typing indicator */
    #typingIndicator {
      font-size: 0.8rem;
      color: #666;
      padding: 0 12px 6px 12px;
      min-height: 20px;
      user-select: none;
    }
    body.night #typingIndicator {
      color: #aaa;
    }

    /* Avatar Picker Modal */
    #avatarPickerOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      overflow-y: auto;
    }
    #avatarPickerModal {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      color: #000;
      max-height: 90vh;
      overflow-y: auto;
    }
    body.night #avatarPickerModal {
      background: #3a3b3c;
      color: #e4e6eb;
    }
    #avatarPickerModal h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-weight: 600;
      text-align: center;
    }
    #avatarGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(60px,1fr));
      gap: 10px;
    }
    #avatarGrid img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
      object-fit: cover;
    }
    #avatarGrid img:hover {
      border-color: #0084ff;
    }
    #avatarPickerCloseBtn {
      margin-top: 15px;
      width: 100%;
      background: #0084ff;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      user-select: none;
    }
    body.night #avatarPickerCloseBtn {
      background: #1877f2;
    }
  </style>
</head>
<body>
  <div class="chat-container" role="main" aria-label="Chat Application">
    <div class="chat-header">
      <div class="title">Quick Chat</div>
      <div class="header-buttons" role="toolbar" aria-label="Chat header controls">
        <button id="avatarPickerBtn" title="Pick Avatar" aria-haspopup="dialog" aria-controls="avatarPickerOverlay" aria-expanded="false">üñºÔ∏è</button>
        <button id="changeUserBtn" title="Change Username/Gender">üë§</button>
        <button id="nightModeBtn" title="Toggle Night Mode">üåô</button>
      </div>
    </div>
    <div class="chat-messages" id="messages" aria-live="polite" aria-relevant="additions"></div>
    <div id="typingIndicator" aria-live="assertive" aria-atomic="true"></div>
    <div class="chat-input">
      <textarea id="text" type="text" placeholder="Type a message‚Ä¶" autocomplete="off" rows="1" spellcheck="false"></textarea>
      <button id="emojiBtn" title="Emoji picker" aria-haspopup="true" aria-expanded="false" aria-controls="emojiPicker">üòä</button>
      <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display:none" />
      <button id="fileBtn" title="Attach file">üìé</button>
      <button id="sendBtn" title="Send message">‚û§</button>
    </div>
    <div class="emoji-picker" id="emojiPicker" role="listbox" aria-label="Emoji picker"></div>
  </div>

  <!-- Modal for username + gender -->
  <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
    <div class="modal" role="document">
      <h2 id="modalTitle">Set Your Profile</h2>
      <label for="usernameInput">Name:</label>
      <input type="text" id="usernameInput" maxlength="30" placeholder="Enter your name" autocomplete="off" />
      <label>Gender:</label>
      <div class="gender-options">
        <label><input type="radio" name="gender" value="male" checked disabled /> Male</label>
        <label><input type="radio" name="gender" value="female" disabled /> Female</label>
      </div>
      <button id="saveProfileBtn">Save</button>
    </div>
  </div>

  <!-- Avatar Picker Modal -->
  <div id="avatarPickerOverlay" role="dialog" aria-modal="true" aria-labelledby="avatarPickerTitle" tabindex="-1">
    <div id="avatarPickerModal" role="document">
      <h2 id="avatarPickerTitle">Pick Your Avatar</h2>
      <div id="avatarGrid" role="list"></div>
      <button id="avatarPickerCloseBtn">Close</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, get, child, set,
      onChildRemoved, onChildChanged, remove, onValue, onDisconnect
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCx_glObBqdqtOs64JhV3fyJW-q9DOqbl0",
      authDomain: "live-chat-app-5ea98.firebaseapp.com",
      databaseURL: "https://live-chat-app-5ea98-default-rtdb.firebaseio.com",
      projectId: "live-chat-app-5ea98",
      storageBucket: "live-chat-app-5ea98.appspot.com",
      messagingSenderId: "58710835031",
      appId: "1:58710835031:web:9248de0eba59c09c0fc812"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages");
    const typingRef = ref(db, "typing");
    const presenceRef = ref(db, "presence");

    // Elements
    const textInput = document.getElementById("text");
    const sendBtn = document.getElementById("sendBtn");
    const fileInput = document.getElementById("fileInput");
    const fileBtn = document.getElementById("fileBtn");
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPicker = document.getElementById("emojiPicker");
    const messagesDiv = document.getElementById("messages");
    const nightModeBtn = document.getElementById("nightModeBtn");
    const changeUserBtn = document.getElementById("changeUserBtn");
    const typingIndicator = document.getElementById("typingIndicator");

    const modalOverlay = document.getElementById("modalOverlay");
    const usernameInput = document.getElementById("usernameInput");
    const saveProfileBtn = document.getElementById("saveProfileBtn");

    // Avatar Picker Elements
    const avatarPickerBtn = document.getElementById("avatarPickerBtn");
    const avatarPickerOverlay = document.getElementById("avatarPickerOverlay");
    const avatarPickerModal = document.getElementById("avatarPickerModal");
    const avatarGrid = document.getElementById("avatarGrid");
    const avatarPickerCloseBtn = document.getElementById("avatarPickerCloseBtn");

    // 20 Male avatars (64x64)
    const maleAvatars = [
      "https://images.unsplash.com/photo-1590650516494-0c8e4a4ba30f?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1584467735871-020fa6acdc20?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1545239351-ef35f43d514b?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1629304722407-f3eb8b8036f0?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1545239351-18547d886ce0?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1573497161003-72c2d3c10553?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1611074884051-380a96ebf748?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1629304722222-36e3d261b1d2?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1604908813740-9355b579a8da?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1604908813849-bf52dca6a3b0?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1584467735827-9d46a6b8ed33?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1590650516600-3b50abcfb4b7?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1607746882042-944635dfe10e?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1517841905240-472988babdf9?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1508214751196-c3a1e9aaaf10?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1544005313-94ddf0286df2?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1508214751196-fdcd1e03a9bb?fit=crop&w=64&h=64&q=80",
      "https://images.unsplash.com/photo-1544005313-94ddf0286df2?fit=crop&w=64&h=64&q=80"
    ];

    // User profile info stored locally
    let currentUser = {
      username: null,
      gender: "male",
      avatar: null,
      userId: null
    };

    // Firebase refs for presence and typing per userId
    let presenceUserRef = null;
    let typingUserRef = null;

    // Utility: save profile locally and in localStorage
    function saveProfileLocally() {
      localStorage.setItem("quickChatUser", JSON.stringify(currentUser));
    }

    function loadProfileLocally() {
      const stored = localStorage.getItem("quickChatUser");
      if (!stored) return false;
      try {
        const parsed = JSON.parse(stored);
        if (parsed.username && parsed.gender) {
          currentUser = parsed;
          return true;
        }
      } catch { }
      return false;
    }

    // Helper: Clear cached avatar image for avatar updates to force reload
    function clearAvatarCache() {
      maleAvatars.forEach(url => {
        // Load image with cache buster to force reload (won't clear browser cache globally)
        const img = new Image();
        img.src = url + "?cb=" + Date.now();
      });
    }

    // Show modal to set username and gender
    function openProfileModal() {
      modalOverlay.style.display = "flex";
      usernameInput.value = currentUser.username || "";
      usernameInput.focus();
    }
    function closeProfileModal() {
      modalOverlay.style.display = "none";
    }

    // Show avatar picker modal
    function openAvatarPicker() {
      avatarPickerOverlay.style.display = "flex";
      avatarPickerBtn.setAttribute("aria-expanded", "true");
      populateAvatarGrid();
    }
    function closeAvatarPicker() {
      avatarPickerOverlay.style.display = "none";
      avatarPickerBtn.setAttribute("aria-expanded", "false");
    }

    // Fill avatar grid in picker modal
    function populateAvatarGrid() {
      avatarGrid.innerHTML = "";
      maleAvatars.forEach((url, idx) => {
        const img = document.createElement("img");
        img.src = url;
        img.alt = `Avatar ${idx + 1}`;
        img.tabIndex = 0;
        img.setAttribute("role", "option");
        img.addEventListener("click", () => {
          currentUser.avatar = url;
          saveProfileLocally();
          closeAvatarPicker();
          renderMessages();
        });
        img.addEventListener("keydown", e => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            img.click();
          }
        });
        // Highlight currently selected avatar
        if (currentUser.avatar === url) {
          img.style.borderColor = "#0084ff";
        }
        avatarGrid.appendChild(img);
      });
    }

    // Generate a userId for presence/typing use (persistent)
    function generateUserId() {
      let id = localStorage.getItem("quickChatUserId");
      if (!id) {
        id = "u" + Math.random().toString(36).slice(2, 10);
        localStorage.setItem("quickChatUserId", id);
      }
      return id;
    }

    // Initialize user profile or ask for username + gender
    function initializeUser() {
      if (!loadProfileLocally()) {
        openProfileModal();
      } else {
        if (!currentUser.avatar) {
          // assign random avatar initially if none selected yet
          currentUser.avatar = maleAvatars[Math.floor(Math.random() * maleAvatars.length)];
          saveProfileLocally();
        }
        currentUser.userId = generateUserId();
        setupPresence();
      }
    }

    // Presence (online/offline) tracking
    function setupPresence() {
      currentUser.userId = generateUserId();
      presenceUserRef = ref(db, `presence/${currentUser.userId}`);
      typingUserRef = ref(db, `typing/${currentUser.userId}`);

      // Mark user online when connected
      const connectedRef = ref(db, ".info/connected");
      onValue(connectedRef, snap => {
        if (snap.val() === true) {
          set(presenceUserRef, {
            username: currentUser.username,
            gender: currentUser.gender,
            avatar: currentUser.avatar,
            lastActive: Date.now()
          });
          onDisconnect(presenceUserRef).remove();
          onDisconnect(typingUserRef).remove();
        }
      });

      // Update lastActive periodically every 30 sec
      setInterval(() => {
        set(presenceUserRef, {
          username: currentUser.username,
          gender: currentUser.gender,
          avatar: currentUser.avatar,
          lastActive: Date.now()
        });
      }, 30000);

      listenPresence();
    }

    // Listen to all users presence and update avatars with online/offline dots
    const onlineUsers = new Map();

    function listenPresence() {
      onValue(ref(db, "presence"), snap => {
        onlineUsers.clear();
        const val = snap.val() || {};
        for (const [uid, user] of Object.entries(val)) {
          // Consider online if lastActive within last 45 sec
          if (Date.now() - user.lastActive < 45000) {
            onlineUsers.set(uid, user);
          }
        }
        renderMessages();
      });
    }

    // Typing indicator management
    let typingTimeout;
    let typingUsers = new Set();

    function setTyping(isTyping) {
      if (!typingUserRef) return;
      if (isTyping) {
        set(typingUserRef, true);
      } else {
        remove(typingUserRef);
      }
    }

    function listenTyping() {
      onValue(ref(db, "typing"), snap => {
        typingUsers.clear();
        const val = snap.val() || {};
        for (const uid in val) {
          if (uid !== currentUser.userId) {
            typingUsers.add(uid);
          }
        }
        updateTypingIndicator();
      });
    }

    function updateTypingIndicator() {
      if (typingUsers.size === 0) {
        typingIndicator.textContent = "";
        return;
      }
      // Show usernames typing
      const names = [];
      for (const uid of typingUsers) {
        const user = onlineUsers.get(uid);
        if (user && user.username) names.push(user.username);
      }
      if (names.length === 0) {
        typingIndicator.textContent = "";
      } else if (names.length === 1) {
        typingIndicator.textContent = `${names[0]} is typing...`;
      } else {
        typingIndicator.textContent = `${names.join(", ")} are typing...`;
      }
    }

    // Message sending
    sendBtn.addEventListener("click", () => {
      sendMessage();
    });

    textInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      } else {
        setTyping(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          setTyping(false);
        }, 1500);
      }
    });

    // File send
    fileBtn.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        if (file.size > 5 * 1024 * 1024) {
          alert("File size exceeds 5MB limit");
          fileInput.value = "";
          return;
        }
        sendFile(file);
        fileInput.value = "";
      }
    });

    // Emoji picker toggle
    emojiBtn.addEventListener("click", () => {
      const visible = emojiPicker.style.display === "flex";
      emojiPicker.style.display = visible ? "none" : "flex";
      emojiBtn.setAttribute("aria-expanded", String(!visible));
    });

    // Populate emojis
    const emojis = ["üòÄ","üòÅ","üòÇ","ü§£","üòÉ","üòÑ","üòÖ","üòÜ","üòâ","üòä","üòã","üòé","üòç","üòò","üòó","üòô","üòö","üôÇ","ü§ó","ü§î","üòê","üòë","üò∂","üôÑ","üòè"];
    emojis.forEach(emoji => {
      const span = document.createElement("span");
      span.textContent = emoji;
      span.setAttribute("role","option");
      span.tabIndex = 0;
      span.addEventListener("click", () => {
        insertAtCursor(textInput, emoji);
        emojiPicker.style.display = "none";
        emojiBtn.setAttribute("aria-expanded", "false");
        textInput.focus();
      });
      span.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          span.click();
        }
      });
      emojiPicker.appendChild(span);
    });

    // Insert text at cursor position helper
    function insertAtCursor(el, text) {
      const start = el.selectionStart;
      const end = el.selectionEnd;
      const before = el.value.substring(0, start);
      const after = el.value.substring(end);
      el.value = before + text + after;
      el.selectionStart = el.selectionEnd = start + text.length;
      el.focus();
    }

    // Send message function
    function sendMessage() {
      const message = textInput.value.trim();
      if (!message) return;
      const messageData = {
        username: currentUser.username,
        gender: currentUser.gender,
        avatar: currentUser.avatar,
        userId: currentUser.userId,
        text: message,
        timestamp: Date.now()
      };
      push(messagesRef, messageData);
      textInput.value = "";
      setTyping(false);
    }

    // Send file as message (upload not implemented, send as base64 for demo)
    function sendFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        const messageData = {
          username: currentUser.username,
          gender: currentUser.gender,
          avatar: currentUser.avatar,
          userId: currentUser.userId,
          fileName: file.name,
          fileType: file.type,
          fileData: reader.result,
          timestamp: Date.now()
        };
        push(messagesRef, messageData);
      };
      reader.readAsDataURL(file);
    }

    // Listen for new messages & render
    onChildAdded(messagesRef, snap => {
      const message = snap.val();
      message.key = snap.key;
      addMessageToDOM(message);
    });

    // Render all messages (clears and reloads all)
    async function renderMessages() {
      messagesDiv.innerHTML = "";
      const snapshot = await get(messagesRef);
      const messages = [];
      snapshot.forEach(snap => {
        messages.push({ key: snap.key, ...snap.val() });
      });
      messages.sort((a,b) => a.timestamp - b.timestamp);
      messages.forEach(addMessageToDOM);
    }

    // Create message DOM and append
    function addMessageToDOM(msg) {
      if (document.getElementById(msg.key)) return; // already exists

      const isYou = msg.userId === currentUser.userId;

      const messageEl = document.createElement("div");
      messageEl.classList.add("message");
      if (isYou) messageEl.classList.add("you");
      messageEl.id = msg.key;

      // Avatar with presence dot if online
      const avatarImg = document.createElement("img");
      avatarImg.classList.add("avatar");
      avatarImg.src = msg.avatar || maleAvatars[Math.floor(Math.random()*maleAvatars.length)];
      avatarImg.alt = msg.username + " avatar";
      // Add presence dot if user online
      if (onlineUsers.has(msg.userId)) {
        avatarImg.classList.add("presence-online");
      }
      messageEl.appendChild(avatarImg);

      // Content container
      const contentDiv = document.createElement("div");
      contentDiv.classList.add("message-content");

      // Username
      const senderDiv = document.createElement("div");
      senderDiv.classList.add("sender");
      senderDiv.textContent = msg.username || "Unknown";
      contentDiv.appendChild(senderDiv);

      // Message bubble or file
      const bubbleDiv = document.createElement("div");
      bubbleDiv.classList.add("bubble");
      if (msg.text) {
        bubbleDiv.textContent = msg.text;
      } else if (msg.fileData) {
        // File message - handle image and others
        if (msg.fileType && msg.fileType.startsWith("image/")) {
          const imgFile = document.createElement("img");
          imgFile.src = msg.fileData;
          imgFile.alt = msg.fileName || "Image";
          imgFile.style.maxWidth = "200px";
          imgFile.style.borderRadius = "8px";
          bubbleDiv.innerHTML = "";
          bubbleDiv.appendChild(imgFile);
        } else {
          bubbleDiv.textContent = `üìé File: ${msg.fileName || "unknown"}`;
        }
      } else {
        bubbleDiv.textContent = "[Unsupported message]";
      }
      contentDiv.appendChild(bubbleDiv);

      messageEl.appendChild(contentDiv);
      messagesDiv.appendChild(messageEl);

      // Scroll to bottom
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Change user profile btn
    changeUserBtn.addEventListener("click", () => {
      openProfileModal();
    });

    // Save profile btn
    saveProfileBtn.addEventListener("click", () => {
      const name = usernameInput.value.trim();
      if (!name) {
        alert("Please enter a valid name");
        return;
      }
      currentUser.username = name;
      currentUser.gender = "male"; // currently fixed male only, but ready for female if you enable radio
      if (!currentUser.avatar) {
        currentUser.avatar = maleAvatars[Math.floor(Math.random()*maleAvatars.length)];
      }
      saveProfileLocally();
      closeProfileModal();

      currentUser.userId = generateUserId();

      // Update presence
      setupPresence();

      // Clear messages and re-render to update avatar and username
      messagesDiv.innerHTML = "";
      renderMessages();
    });

    // Night mode toggle
    nightModeBtn.addEventListener("click", () => {
      document.body.classList.toggle("night");
      localStorage.setItem("quickChatNightMode", document.body.classList.contains("night"));
    });
    // Load night mode from storage
    if (localStorage.getItem("quickChatNightMode") === "true") {
      document.body.classList.add("night");
    }

    // Avatar Picker btn open
    avatarPickerBtn.addEventListener("click", () => {
      openAvatarPicker();
    });

    avatarPickerCloseBtn.addEventListener("click", () => {
      closeAvatarPicker();
    });

    // Close modals on ESC
    window.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        if (modalOverlay.style.display === "flex") closeProfileModal();
        if (avatarPickerOverlay.style.display === "flex") closeAvatarPicker();
      }
    });

    // Initialization
    initializeUser();
    listenTyping();

    // Clear avatar cache on page load to avoid stale images
    clearAvatarCache();
  </script>
</body>
</html>
