<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick Chat</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI',Arial,sans-serif; background: #eceef0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; transition: background 0.3s; }
    body.night { background: #18191a; }
    .chat-container { width: 100%; max-width: 380px; height: 600px; background: #ffffff; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 2px 12px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
    body.night .chat-container { background: #242526; }
    .chat-header { background: #0084ff; color: white; padding: 12px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .chat-header .title { font-size: 1rem; }
    .chat-header .header-buttons { display: flex; align-items: center; gap: 10px; }
    .chat-header button { background: transparent; border: none; font-size: 1.2rem; color: white; cursor: pointer; }
    .chat-messages { flex: 1; padding: 12px; overflow-y: auto; background: #f0f2f5; }
    body.night .chat-messages { background: #3a3b3c; }
    .message { display: flex; align-items: flex-start; margin-bottom: 14px; max-width: 100%; }
    .message.you { flex-direction: row-reverse; text-align: right; }
    .avatar { width: 32px; height: 32px; border-radius: 50%; margin: 0 8px; object-fit: cover; flex-shrink: 0; }
    .message-content { max-width: 70%; display: flex; flex-direction: column; }
    .sender { font-size: 0.75rem; color: #666; margin-bottom: 2px; }
    body.night .sender { color: #aaa; }
    .bubble { background: #0084ff; color: white; padding: 8px 12px; border-radius: 18px; word-wrap: break-word; }
    .message.you .bubble { background: #dcf8c6; color: #050505; }
    body.night .bubble { background: #4b4b4b; color: #e4e6eb; }
    .info { font-size: 0.7rem; color: #555; margin-top: 2px; display: flex; justify-content: space-between; align-items: center; }
    body.night .info { color: #aaa; }
    .info .actions { display: none; gap: 8px; cursor: pointer; }
    .message-content:hover .actions { display: inline-flex; }
    .chat-input { padding: 10px; background: #fff; display: flex; align-items: center; gap: 8px; }
    body.night .chat-input { background: #242526; }
    .chat-input input[type="text"] { flex: 1; border: none; padding: 8px 12px; border-radius: 18px; background: #f0f2f5; outline: none; }
    body.night .chat-input input[type="text"] { background: #3a3b3c; color: #e4e6eb; }
    .chat-input button { background: #0084ff; border: none; color: white; padding: 8px; border-radius: 50%; cursor: pointer; }
    body.night .chat-input button { background: #1877f2; }
    .emoji-picker { position: absolute; bottom: 60px; right: 60px; background: #ffffff; border-radius: 8px; padding: 8px; display: none; box-shadow: 0 2px 12px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 6px; z-index: 10; }
    body.night .emoji-picker { background: #3a3b3c; }
    .emoji-picker span { font-size: 1.2rem; cursor: pointer; padding: 4px; border-radius: 4px; }
    .emoji-picker span:hover { background: #0084ff; color: white; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .modal { background: white; padding: 20px; border-radius: 8px; max-width: 320px; width: 90%; box-shadow: 0 2px 12px rgba(0,0,0,0.3); }
    body.night .modal { background: #3a3b3c; color: #e4e6eb; }
    .modal h2 { margin-top: 0; margin-bottom: 15px; font-weight: 600; }
    .modal label { display: block; margin-bottom: 6px; }
    .modal input[type="text"] { width: 100%; padding: 8px 10px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 12px; font-size: 1rem; }
    body.night .modal input[type="text"] { background: #555; border: 1px solid #777; color: #e4e6eb; }
    .gender-options { display: flex; gap: 15px; margin-bottom: 12px; }
    .gender-options label { cursor: pointer; user-select: none; }
    .modal button { background: #0084ff; border: none; color: white; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 1rem; width: 100%; }
    body.night .modal button { background: #1877f2; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="title">Quick Chat</div>
      <div class="header-buttons">
        <button id="changeUserBtn" title="Change Username/Gender">👤</button>
        <button id="nightModeBtn" title="Toggle Night Mode">🌙</button>
      </div>
    </div>
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input">
      <input id="text" type="text" placeholder="Type a message…" autocomplete="off" />
      <button id="emojiBtn">😊</button>
      <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display:none" />
      <button id="fileBtn">📎</button>
      <button id="sendBtn">➤</button>
    </div>
    <div class="emoji-picker" id="emojiPicker"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>Set Your Profile</h2>
      <label>Name:</label>
      <input type="text" id="usernameInput" maxlength="30" placeholder="Enter your name" />
      <label>Gender:</label>
      <div class="gender-options">
        <label><input type="radio" name="gender" value="male" /> Male</label>
        <label><input type="radio" name="gender" value="female" /> Female</label>
      </div>
      <button id="saveProfileBtn">Save</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCx_glObBqdqtOs64JhV3fyJW-q9DOqbl0",
      authDomain: "live-chat-app-5ea98.firebaseapp.com",
      databaseURL: "https://live-chat-app-5ea98-default-rtdb.firebaseio.com",
      projectId: "live-chat-app-5ea98",
      storageBucket: "live-chat-app-5ea98.appspot.com",
      messagingSenderId: "58710835031",
      appId: "1:58710835031:web:9248de0eba59c09c0fc812"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages");

    const textInput = document.getElementById("text");
    const sendBtn = document.getElementById("sendBtn");
    const fileInput = document.getElementById("fileInput");
    const fileBtn = document.getElementById("fileBtn");
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPicker = document.getElementById("emojiPicker");
    const messagesDiv = document.getElementById("messages");
    const nightModeBtn = document.getElementById("nightModeBtn");
    const changeUserBtn = document.getElementById("changeUserBtn");
    const modal = document.getElementById("modalOverlay");
    const usernameInput = document.getElementById("usernameInput");
    const saveProfileBtn = document.getElementById("saveProfileBtn");

    const malePhotos = [
      "https://i.imgur.com/abc1.jpg", "https://i.imgur.com/abc2.jpg", "https://i.imgur.com/abc3.jpg",
      "https://i.imgur.com/abc4.jpg", "https://i.imgur.com/abc5.jpg", "https://i.imgur.com/abc6.jpg",
      "https://i.imgur.com/abc7.jpg", "https://i.imgur.com/abc8.jpg", "https://i.imgur.com/abc9.jpg",
      "https://i.imgur.com/abc10.jpg"
    ];
    const femalePhotos = [
      "https://i.imgur.com/def1.jpg", "https://i.imgur.com/def2.jpg", "https://i.imgur.com/def3.jpg",
      "https://i.imgur.com/def4.jpg", "https://i.imgur.com/def5.jpg", "https://i.imgur.com/def6.jpg",
      "https://i.imgur.com/def7.jpg", "https://i.imgur.com/def8.jpg", "https://i.imgur.com/def9.jpg",
      "https://i.imgur.com/def10.jpg"
    ];

    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash << 5) - hash + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function mulberry32(a) {
      return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    function shuffleWithSeed(arr, seed) {
      let s = mulberry32(seed);
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(s() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function getProfile() {
      const name = sessionStorage.getItem("username");
      const gender = sessionStorage.getItem("gender");
      return name && gender ? { name, gender } : null;
    }

    function setProfile(name, gender) {
      sessionStorage.setItem("username", name);
      sessionStorage.setItem("gender", gender);
      sessionStorage.removeItem("avatar");
      sessionStorage.removeItem("avatarDate");
    }

    function getDailyAvatar(name, gender) {
      const today = new Date().toISOString().slice(0,10);
      const key = `${name}|${gender}|${today}`;
      const storedDate = sessionStorage.getItem("avatarDate");
      const stored = sessionStorage.getItem("avatar");
      if (stored && storedDate === today) return stored;

      let pool = gender === "male" ? [...malePhotos] : [...femalePhotos];
      const seed = hashString(key);
      shuffleWithSeed(pool, seed);
      const avatar = pool[seed % pool.length];
      sessionStorage.setItem("avatar", avatar);
      sessionStorage.setItem("avatarDate", today);
      return avatar;
    }

    function showModal(name = "", gender = "") {
      usernameInput.value = name;
      [...document.getElementsByName("gender")].forEach(r => r.checked = r.value === gender);
      modal.style.display = "flex";
    }

    function saveProfile() {
      const name = usernameInput.value.trim() || "Anonymous";
      const gender = [...document.getElementsByName("gender")].find(r=>r.checked)?.value;
      if (!gender) { alert("Please select gender"); return; }
      setProfile(name, gender);
      modal.style.display = "none";
    }

    function toBase64(f) {
      return new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(f);
      });
    }

    async function sendMessage() {
      const prof = getProfile();
      if (!prof) { showModal(); return; }
      const text = textInput.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;

      const msg = { name: prof.name, gender: prof.gender, timestamp: new Date().toISOString() };
      if (text) msg.text = text;
      if (file) {
        msg.file = await toBase64(file);
        msg.fileName = file.name;
      }
      push(messagesRef, msg);
      textInput.value = "";
      fileInput.value = "";
    }

    function escapeHTML(t) {
      const d = document.createElement("div");
      d.textContent = t;
      return d.innerHTML;
    }

    onChildAdded(messagesRef, snap => {
      const msg = snap.val();
      const prof = getProfile();
      const avatar = getDailyAvatar(msg.name, msg.gender);
      const isMe = prof && msg.name === prof.name;

      const div = document.createElement("div");
      div.className = `message ${isMe?"you":"other"}`;      

      const img = document.createElement("img");
      img.className = "avatar";
      img.src = avatar;
      img.alt = msg.name;

      const content = document.createElement("div");
      content.className = "message-content";

      const sender = document.createElement("div");
      sender.className = "sender";
      sender.textContent = msg.name;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if (msg.text) bubble.innerHTML = escapeHTML(msg.text).replace(/\n/g,"<br>");
      else if (msg.file) {
        if (/\.(jpg|jpeg|png|gif)$/i.test(msg.fileName)) {
          const im = document.createElement("img");
          im.src = msg.file;
          im.style.maxWidth="150px";
          im.style.borderRadius="8px";
          bubble.appendChild(im);
        } else {
          const link = document.createElement("a");
          link.href = msg.file;
          link.target = "_blank";
          link.textContent = msg.fileName;
          bubble.appendChild(link);
        }
      }

      const info = document.createElement("div");
      info.className = "info";
      info.innerHTML = `<span>${new Date(msg.timestamp).toLocaleTimeString()}</span>`;

      content.appendChild(sender);
      content.appendChild(bubble);
      content.appendChild(info);

      if (isMe) {
        div.appendChild(content);
        div.appendChild(img);
      } else {
        div.appendChild(img);
        div.appendChild(content);
      }

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    const emojis = ["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😍","😘"];
    emojis.forEach(e=> {
      const span = document.createElement("span");
      span.textContent = e;
      span.onclick = ()=> { textInput.value+=e; textInput.focus(); };
      emojiPicker.appendChild(span);
    });

    emojiBtn.onclick = () => emojiPicker.style.display = emojiPicker.style.display==="flex"?"none":"flex";
    fileBtn.onclick = ()=> fileInput.click();
    sendBtn.onclick = sendMessage;
    textInput.addEventListener("keydown", e=> { if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMessage(); } });
    changeUserBtn.onclick = ()=> {
      const prof = getProfile();
      showModal(prof?.name, prof?.gender);
    };
    saveProfileBtn.onclick = saveProfile;
    window.onload = ()=> { if(!getProfile()) showModal(); };

    nightModeBtn.onclick = ()=> document.body.classList.toggle("night");
  </script>
</body>
</html>
