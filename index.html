<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fakebook Chat</title>
<style>
  body { margin: 0; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; color: #1c1e21; }
  body.night { background: #18191a; color: #e4e6eb; }
  header { background: #1877f2; color: white; padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
  header h1 { margin: 0; font-size: 1.4em; font-weight: 500; }
  #changeUserBtn, #nightModeBtn, #avatarPickerBtn, #changePasskeyBtn { background: #1877f2; border: 1px solid #1c2526; border-radius: 6px; padding: 6px 12px; cursor: pointer; margin-left: 8px; font-weight: 500; color: white; font-size: 0.9em; }
  #changeUserBtn:hover, #nightModeBtn:hover, #avatarPickerBtn:hover, #changePasskeyBtn:hover { background: #1659b7; }
  #messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; background: #fff; }
  body.night #messages { background: #242526; }
  .message { display: flex; gap: 8px; outline: none; position: relative; max-width: 80%; }
  .message.you { flex-direction: row-reverse; align-self: flex-end; }
  .avatar-container { display: flex; flex-direction: column; align-items: center; }
  .avatar { width: 36px; height: 36px; border-radius: 50%; position: relative; }
  .avatar-username { font-weight: 500; font-size: 0.85em; margin-bottom: 4px; text-align: center; }
  .presence-online::after { content: ""; position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #31a24c; border: 2px solid white; border-radius: 50%; }
  .presence-offline::after { content: ""; position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #b0b3b8; border: 2px solid white; border-radius: 50%; }
  .message-content { display: flex; flex-direction: column; }
  .bubble { background: #e7f3ff; color: #1c1e21; border-radius: 18px; padding: 8px 12px; white-space: pre-wrap; word-break: break-word; font-size: 0.95em; line-height: 1.4; position: relative; }
  body.night .bubble { background: #3a3b3c; color: #e4e6eb; }
  .message.you .bubble { background: #1877f2; color: white; }
  body.night .message.you .bubble { background: #2374e1; }
  .bubble .emoji { font-size: 1.4em; vertical-align: middle; }
  .bubble .file-preview { max-width: 200px; border-radius: 12px; margin-top: 5px; cursor: pointer; position: relative; }
  .bubble .pdf-preview { width: 100%; height: 200px; border: none; border-radius: 12px; margin-top: 5px; cursor: pointer; }
  .bubble .doc-preview { width: 100px; height: 100px; background: url('https://img.icons8.com/ios/50/000000/document.png') no-repeat center; background-size: contain; margin-top: 5px; cursor: pointer; position: relative; }
  .bubble .download-icon { position: absolute; bottom: 5px; right: 5px; width: 24px; height: 24px; background: url('https://img.icons8.com/ios/24/ffffff/download.png') no-repeat center; background-size: contain; display: none; }
  .bubble .file-preview:hover .download-icon, .bubble .pdf-preview:hover .download-icon, .bubble .doc-preview:hover .download-icon { display: block; }
  .info { font-size: 0.7em; color: #65676b; margin-top: 2px; display: none; justify-content: space-between; align-items: center; }
  .message:hover .info, .message.touched .info { display: flex; }
  body.night .info { color: #b0b3b8; }
  .actions { display: none; position: absolute; top: -28px; background: rgba(0, 0, 0, 0.7); border-radius: 20px; padding: 4px; animation: fadeIn 0.2s ease-in; }
  .message:hover .actions, .message.touched .actions { display: flex; }
  .message.you .actions { right: 8px; }
  .message:not(.you) .actions { left: 48px; }
  .actions button { background: transparent; border: none; cursor: pointer; font-size: 1em; margin: 0 4px; color: #e4e6eb; }
  .actions button:hover { color: #f02849; }
  .actions button.delete-btn::before { content: "ğŸ—‘ï¸"; }
  .actions button.edit-btn::before { content: "âœ"; }
  @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
  #typingIndicator { height: 20px; padding: 0 16px; font-style: italic; color: #65676b; display: flex; align-items: center; gap: 5px; font-size: 0.85em; }
  body.night #typingIndicator { color: #b0b3b8; }
  .typing-dots { display: inline-flex; align-items: center; }
  .typing-dots span { width: 6px; height: 6px; background: #65676b; border-radius: 50%; margin: 0 2px; animation: typing 1.2s infinite; }
  body.night .typing-dots span { background: #b0b3b8; }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
  footer { padding: 8px 16px; background: #fff; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.1); }
  body.night footer { background: #242526; }
  #text { flex: 1; padding: 10px; font-size: 0.95em; border-radius: 20px; border: none; background: #f0f2f5; color: #1c1e21; }
  body.night #text { background: #3a3b3c; color: #e4e6eb; }
  button { cursor: pointer; border: none; background: #1877f2; color: white; border-radius: 6px; padding: 8px 12px; font-weight: 500; font-size: 0.9em; }
  button:hover { background: #1659b7; }
  #fileInput { display: none; }
  #fileBtn, #emojiBtn, #sendBtn { background: none; color: #65676b; font-size: 1.2em; padding: 8px; }
  body.night #fileBtn, body.night #emojiBtn, body.night #sendBtn { color: #b0b3b8; }
  #fileBtn:hover, #emojiBtn:hover, #sendBtn:hover { color: #1877f2; }
  body.night #fileBtn:hover, body.night #emojiBtn:hover, body.night #sendBtn:hover { color: #2374e1; }
  #emojiPicker { position: absolute; background: #fff; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); width: 300px; max-height: 200px; overflow-y: auto; padding: 10px; z-index: 10; display: none; grid-template-columns: repeat(8, 1fr); gap: 4px; }
  body.night #emojiPicker { background: #3a3b3c; border: 1px solid #4b4c4f; color: #e4e6eb; }
  #emojiPicker::-webkit-scrollbar { width: 6px; }
  #emojiPicker::-webkit-scrollbar-thumb { background: #b0b3b8; border-radius: 3px; }
  body.night #emojiPicker::-webkit-scrollbar-thumb { background: #606770; }
  #emojiPicker span { cursor: pointer; font-size: 1.4em; padding: 4px; text-align: center; }
  #emojiPicker span:hover, #emojiPicker span:focus { background: #e7f3ff; border-radius: 6px; outline: none; }
  body.night #emojiPicker span:hover, body.night #emojiPicker span:focus { background: #4b4c4f; }
  .reaction-picker { position: absolute; background: #fff; border: 1px solid #ddd; padding: 6px; border-radius: 12px; z-index: 10; display: none; flex-direction: column; gap: 6px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); animation: reactionPop 0.2s ease-out; }
  body.night .reaction-picker { background: #3a3b3c; border: 1px solid #4b4c4f; }
  .reaction-picker span { cursor: pointer; font-size: 1.4em; padding: 4px; transition: transform 0.2s; text-align: center; }
  .reaction-picker span:hover, .reaction-picker span:focus { transform: scale(1.2); outline: none; }
  @keyframes reactionPop { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
  .reactions { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; font-size: 0.9em; align-items: flex-end; }
  .message:not(.you) .reactions { align-items: flex-start; }
  .reaction { background: #e7f3ff; border-radius: 12px; padding: 4px 8px; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 6px; }
  body.night .reaction { background: #4b4c4f; }
  .reaction:hover { transform: scale(1.1); }
  .reaction-users { position: absolute; background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 8px; z-index: 20; max-width: 200px; font-size: 0.8em; display: none; flex-direction: column; gap: 4px; }
  body.night .reaction-users { background: #3a3b3c; border: 1px solid #4b4c4f; color: #e4e6eb; }
  .reaction-users div { padding: 4px; border-radius: 4px; }
  .reaction-users div:hover { background: #e7f3ff; }
  body.night .reaction-users div:hover { background: #4b4c4f; }
  #modalOverlay, #avatarPickerOverlay, #passkeyOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
  #modalContent, #avatarPickerModal, #passkeyModal { background: white; padding: 20px; border-radius: 12px; width: 300px; max-width: 90%; box-sizing: border-box; outline: none; }
  body.night #modalContent, body.night #avatarPickerModal, body.night #passkeyModal { background: #3a3b3c; color: #e4e6eb; }
  #modalContent h2, #avatarPickerModal h2, #passkeyModal h2 { margin: 0 0 10px; font-size: 1.2em; font-weight: 500; }
  #usernameInput, #passkeyInput, #oldPasskeyInput, #builtinPasskeyInput { width: 100%; padding: 10px; font-size: 0.95em; margin-bottom: 12px; border-radius: 6px; border: 1px solid #ddd; }
  body.night #usernameInput, body.night #passkeyInput, body.night #oldPasskeyInput, body.night #builtinPasskeyInput { background: #4b4c4f; border: 1px solid #606770; color: #e4e6eb; }
  #saveProfileBtn, #savePasskeyBtn, #resetPasskeyBtn, #closeProfileBtn, #closePasskeyBtn { width: 100%; padding: 10px; font-weight: 500; }
  #closeProfileBtn, #closePasskeyBtn { background: #f02849; margin-top: 10px; }
  .avatar-option { width: 48px; height: 48px; border-radius: 50%; margin: 4px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
  .avatar-option.selected { border-color: #1877f2; }
  .avatar-option:hover, .avatar-option:focus { border-color: #1659b7; outline: none; }
  #avatarOptions { max-height: 200px; overflow-y: auto; display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; padding: 10px; }
  #avatarOptions::-webkit-scrollbar { width: 6px; }
  #avatarOptions::-webkit-scrollbar-thumb { background: #b0b3b8; border-radius: 3px; }
  body.night #avatarOptions::-webkit-scrollbar-thumb { background: #606770; }
  #welcomeMessage { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8em; font-weight: bold; color: #1877f2; text-align: center; animation: fadeOut 3s forwards; z-index: 1000; }
  #chatContainer { display: none; flex-direction: column; height: 100vh; }
  @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; display: none; } }
</style>
</head>
<body>

<div id="passkeyOverlay" role="dialog" aria-modal="true" aria-labelledby="passkeyTitle">
  <div id="passkeyModal" tabindex="0">
    <h2 id="passkeyTitle">Set Your Passkey</h2>
    <input type="password" id="passkeyInput" aria-required="true" aria-describedby="passkeyTitle" placeholder="Enter your passkey" />
    <input type="password" id="oldPasskeyInput" aria-required="true" aria-describedby="passkeyTitle" placeholder="Enter reset code" style="display: none;" />
    <input type="password" id="builtinPasskeyInput" aria-required="true" aria-describedby="passkeyTitle" placeholder="Enter built-in passkey" style="display: none;" />
    <button id="savePasskeyBtn">Submit</button>
    <button id="resetPasskeyBtn" style="background: #f02849; margin-top: 10px;">Reset Passkey</button>
    <button id="closePasskeyBtn" style="background: #f02849; margin-top: 10px;">Close</button>
    <div id="passkeyError" style="color: red; font-size: 0.8em; margin-top: 10px; display: none;"></div>
  </div>
</div>

<div id="welcomeMessage" style="display: none;">Welcome to Fakebook</div>

<div id="chatContainer">
  <header>
    <h1>Fakebook Chat</h1>
    <div>
      <button id="avatarPickerBtn" title="Pick Avatar" aria-label="Pick Avatar">Pick Avatar</button>
      <button id="changeUserBtn" title="Change Username" aria-label="Change Username">Change User Name</button>
      <button id="changePasskeyBtn" title="Change Passkey" aria-label="Change Passkey">Change Passkey</button>
      <button id="nightModeBtn" title="Toggle Night Mode" aria-label="Toggle Night Mode">ğŸŒ”</button>
    </div>
  </header>
  <div id="messages" tabindex="0" aria-live="polite" aria-label="Chat messages"></div>
  <div id="typingIndicator" aria-live="polite" aria-atomic="true"></div>
  <footer>
    <button id="fileBtn" title="Send File" aria-label="Send File">ğŸ”—</button>
    <input type="file" id="fileInput" aria-label="File input" accept="image/jpeg,image/png,image/gif,image/webp,image/bmp,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
    <button id="emojiBtn" title="Emoji Picker" aria-label="Emoji Picker">ğŸ˜Š</button>
    <input type="text" id="text" placeholder="Type a message..." autocomplete="off" aria-label="Message input" />
    <button id="sendBtn" title="Send Message" aria-label="Send Message">â¤</button>
  </footer>
</div>

<div id="emojiPicker" role="listbox" aria-label="Emoji picker"></div>

<div id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div id="modalContent" tabindex="0">
    <h2 id="modalTitle">Enter Username</h2>
    <input type="text" id="usernameInput" aria-required="true" aria-describedby="modalTitle" placeholder="Enter your username" />
    <div id="usernameError" style="color: red; font-size: 0.8em; margin-top: 10px; display: none;"></div>
    <button id="saveProfileBtn">Save</button>
    <button id="closeProfileBtn">Close</button>
  </div>
</div>

<div id="avatarPickerOverlay" role="dialog" aria-modal="true" aria-labelledby="avatarPickerTitle">
  <div id="avatarPickerModal" tabindex="0"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved,
    get, set, remove, onValue, onDisconnect, update
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCx_glObBqdqtOs64JhV3fyJW-q9DOqbl0",
    authDomain: "live-chat-app-5ea98.firebaseapp.com",
    databaseURL: "https://live-chat-app-5ea98-default-rtdb.firebaseio.com",
    projectId: "live-chat-app-5ea98",
    storageBucket: "live-chat-app-5ea98.appspot.com",
    messagingSenderId: "58710835031",
    appId: "1:58710835031:web:9248de0eba59c09c0fc812"
  };

  let app, db, auth, messagesRef, typingRef, presenceRef, connectedRef, usersRef;

  try {
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    auth = getAuth(app);

    messagesRef = ref(db, "messages");
    typingRef = ref(db, "typing");
    presenceRef = ref(db, "presence");
    connectedRef = ref(db, ".info/connected");
    usersRef = ref(db, "users");
  } catch (error) {
    console.error("Firebase initialization failed:", error);
    const errorDiv = document.createElement("div");
    errorDiv.textContent = "Unable to connect to the server. Please check your internet connection.";
    errorDiv.style.color = "red";
    errorDiv.style.padding = "10px";
    document.body.prepend(errorDiv);
  }

  // Automatically sign in anonymously
  signInAnonymously(auth)
    .then(() => console.log("Signed in anonymously"))
    .catch((error) => {
      console.error("Anonymous sign-in failed:", error);
    });

  let userId = null;

  // Listen for auth state changes
  onAuthStateChanged(auth, (user) => {
    if (user) {
      userId = user.uid;
      console.log("Authenticated UID:", userId);
    } else {
      userId = null;
      console.warn("No user signed in");
    }
  });

  const textInput = document.getElementById("text");
  const sendBtn = document.getElementById("sendBtn");
  const fileInput = document.getElementById("fileInput");
  const fileBtn = document.getElementById("fileBtn");
  const emojiBtn = document.getElementById("emojiBtn");
  const emojiPicker = document.getElementById("emojiPicker");
  const messagesDiv = document.getElementById("messages");
  const nightModeBtn = document.getElementById("nightModeBtn");
  const changeUserBtn = document.getElementById("changeUserBtn");
  const changePasskeyBtn = document.getElementById("changePasskeyBtn");
  const typingIndicator = document.getElementById("typingIndicator");
  const modalOverlay = document.getElementById("modalOverlay");
  const usernameInput = document.getElementById("usernameInput");
  const usernameError = document.getElementById("usernameError");
  const saveProfileBtn = document.getElementById("saveProfileBtn");
  const closeProfileBtn = document.getElementById("closeProfileBtn");
  const avatarPickerOverlay = document.getElementById("avatarPickerOverlay");
  const avatarPickerModal = document.getElementById("avatarPickerModal");
  const avatarPickerBtn = document.getElementById("avatarPickerBtn");
  const passkeyOverlay = document.getElementById("passkeyOverlay");
  const passkeyModal = document.getElementById("passkeyModal");
  const passkeyInput = document.getElementById("passkeyInput");
  const oldPasskeyInput = document.getElementById("oldPasskeyInput");
  const builtinPasskeyInput = document.getElementById("builtinPasskeyInput");
  const savePasskeyBtn = document.getElementById("savePasskeyBtn");
  const resetPasskeyBtn = document.getElementById("resetPasskeyBtn");
  const closePasskeyBtn = document.getElementById("closePasskeyBtn");
  const passkeyError = document.getElementById("passkeyError");
  const welcomeMessage = document.getElementById("welcomeMessage");
  const chatContainer = document.getElementById("chatContainer");

  const BUILT_IN_RESET_PASSKEY = "DarkChat";
  const maleAvatars = Array.from({ length: 100 }, (_, i) => `https://randomuser.me/api/portraits/men/${i + 1}.jpg`);
  const emojis = ["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ","ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¥³","ğŸ¤—","ğŸ¤”","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ˜¶","ğŸ˜","ğŸ˜‘","ğŸ˜¬","ğŸ™„","ğŸ˜","ğŸ˜£","ğŸ˜¥","ğŸ˜®","ğŸ¤","ğŸ˜¯","ğŸ˜ª","ğŸ˜«","ğŸ¥±","ğŸ˜´","ğŸ˜Œ","ğŸ˜”","ğŸ˜•","ğŸ™ƒ","ğŸ˜¢","ğŸ˜­","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜³","ğŸ¥µ","ğŸ¥¶","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ˜¥","ğŸ˜“","ğŸ¤¤","ğŸ˜´","ğŸ˜µ","ğŸ¤","ğŸ¥´","ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤‘","ğŸ¤ ","ğŸ˜ˆ","ğŸ‘¿","ğŸ‘¹","ğŸ‘º","ğŸ’€","ğŸ‘»","ğŸ‘½","ğŸ¤–","ğŸ’©","ğŸ˜º","ğŸ˜¸","ğŸ˜¹","ğŸ˜»","ğŸ˜¼","ğŸ˜½","ğŸ™€","ğŸ˜¿","ğŸ˜¾","ğŸ‘‹","ğŸ¤š","ğŸ–","âœ‹","ğŸ––","ğŸ‘Œ","ğŸ¤Œ","ğŸ¤","âœŒ","ğŸ¤","ğŸ¤Ÿ","ğŸ¤˜","ğŸ¤™","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ–•","ğŸ‘‡","â˜","ğŸ‘","ğŸ‘","âœŠ","ğŸ‘Š","ğŸ¤›","ğŸ¤œ","ğŸ‘","ğŸ™Œ","ğŸ‘","ğŸ¤²","ğŸ¤","ğŸ™","âœ","ğŸ’…","ğŸ¤³","ğŸ’ª","ğŸ¦¾","ğŸ¦µ","ğŸ¦¿","ğŸ¦¶"];
  const reactionEmojis = ["ğŸ‘", "â¤ï¸", "ğŸ˜‚", "ğŸ˜®", "ğŸ˜¢", "ğŸ˜¡"];

  let currentUser = null;
  let typingTimeout = null;
  let isTyping = false;
  let messagesCache = [];
  let presenceMap = new Map();
  let selectedAvatarUrl = null;
  const usersMap = new Map();
  let isScrolledToBottom = true;
  let isPasskeySet = false;
  let isPasskeyVerified = false;
  let sessionVerified = false;

  function saveUserToLocal(user) { try { localStorage.setItem("quickchat-user", JSON.stringify(user)); } catch (e) { console.error("Error saving user", e); } }
  function loadUserFromLocal() { try { const s = localStorage.getItem("quickchat-user"); return s ? JSON.parse(s) : null; } catch (e) { console.error("Error loading user", e); return null; } }
  function saveNightMode(enabled) { try { localStorage.setItem("quickchat-nightmode", enabled ? "1" : "0"); } catch (e) {} }
  function loadNightMode() { try { return localStorage.getItem("quickchat-nightmode") === "1"; } catch (e) { return false; } }
  function savePasskeyToLocal(passkey) { try { localStorage.setItem("quickchat-passkey", passkey); } catch (e) {} }
  function loadPasskeyFromLocal() { try { return localStorage.getItem("quickchat-passkey"); } catch (e) { return null; } }
  function saveSessionVerified() { try { sessionStorage.setItem("quickchat-session-verified", "true"); } catch (e) {} }
  function loadSessionVerified() { try { return sessionStorage.getItem("quickchat-session-verified") === "true"; } catch (e) { return false; } }

  function escapeHTML(str) {
    if (!str) return "";
    return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
  }

  function formatTime(ts) {
    try { return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); }
    catch { return "??:??"; }
  }

  function getAvatarForUser(user) {
    if (user.avatar) return user.avatar;
    const idx = hashCode((user.username || "") + (userId || "")) % maleAvatars.length;
    return maleAvatars[Math.abs(idx)];
  }

  function hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return hash;
  }

  function styleEmojis(text) {
    const emojiRegex = /[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;
    return text.replace(emojiRegex, '<span class="emoji">$&</span>');
  }

  function makeLinksClickable(text) {
    const urlRegex = /(https?:\/\/[^\s<>"']+)/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:underline;">$1</a>');
  }

  function cacheUserInfo(msg) {
    if (msg?.userId && msg?.username) {
      usersMap.set(msg.userId, { username: msg.username, avatar: msg.avatar });
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // renderMessage, showReactionUsers, updateUserMessages, updateUserAvatars, renderAllMessagesPresence, addMessage
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // (these functions remain unchanged â€“ omitted here for brevity)

  async function cleanupOldMessages() {
    try {
      const threeDaysAgo = Date.now() - 3 * 24 * 60 * 60 * 1000;
      const snap = await get(messagesRef);
      const msgs = snap.val() || {};
      for (const [id, msg] of Object.entries(msgs)) {
        if (msg.timestamp < threeDaysAgo) {
          await remove(ref(db, `messages/${id}`));
        }
      }
    } catch (err) {
      console.error("cleanupOldMessages failed", err);
    }
  }

  async function sendMessage(text, fileUrl = null, fileName = null) {
    if (!text && !fileUrl) return;
    if (!userId) return; // â† security guard

    if (!currentUser || !isPasskeyVerified) {
      passkeyError.textContent = "Please complete the setup process.";
      passkeyError.style.display = "block";
      openPasskeyModal(isPasskeySet ? "verify" : "set");
      return;
    }

    try {
      const msg = {
        text: text || "",
        fileUrl: fileUrl || null,
        fileName: fileName || null,
        timestamp: Date.now(),
        userId,
        username: currentUser.username,
        avatar: selectedAvatarUrl
      };
      await push(messagesRef, msg);
      textInput.value = "";
      stopTyping();
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (error) {
      console.error("sendMessage failed", error);
      passkeyError.textContent = "Failed to send: " + error.message;
      passkeyError.style.display = "block";
    }
  }

  async function deleteMessage(messageId) {
    if (!userId) return; // â† guard

    const msg = messagesCache.find(m => m.id === messageId);
    if (!msg || msg.userId !== userId) return;
    if (!confirm("Delete this message?")) return;

    try {
      await remove(ref(db, `messages/${messageId}`));
      messagesCache = messagesCache.filter(m => m.id !== messageId);
    } catch (err) {
      console.error("deleteMessage failed", err);
      passkeyError.textContent = "Delete failed: " + err.message;
      passkeyError.style.display = "block";
    }
  }

  async function editMessage(msg) {
    if (!userId) return; // â† guard
    if (!msg.text) return;

    const newText = prompt("Edit message:", msg.text);
    if (!newText || newText.trim() === msg.text) return;

    try {
      await update(ref(db, `messages/${msg.id}`), { text: newText.trim() });
    } catch (err) {
      console.error("editMessage failed", err);
      passkeyError.textContent = "Edit failed: " + err.message;
      passkeyError.style.display = "block";
    }
  }

  async function addReaction(messageId, emoji) {
    if (!userId) return; // â† guard

    try {
      const msgRef = ref(db, `messages/${messageId}/reactions`);
      const snap = await get(msgRef);
      let reactions = snap.val() || {};

      const userReaction = Object.entries(reactions).find(([, users]) => users.includes(userId));
      if (userReaction && userReaction[0] === emoji) {
        reactions[userReaction[0]] = reactions[userReaction[0]].filter(uid => uid !== userId);
        if (reactions[userReaction[0]].length === 0) delete reactions[userReaction[0]];
      } else {
        if (userReaction) {
          reactions[userReaction[0]] = reactions[userReaction[0]].filter(uid => uid !== userId);
          if (reactions[userReaction[0]].length === 0) delete reactions[userReaction[0]];
        }
        if (!reactions[emoji]) reactions[emoji] = [];
        if (!reactions[emoji].includes(userId)) reactions[emoji].push(userId);
      }

      await set(msgRef, reactions);
    } catch (err) {
      console.error("addReaction failed", err);
      passkeyError.textContent = "Reaction failed: " + err.message;
      passkeyError.style.display = "block";
    }
  }

  function startTyping() {
    if (isTyping || !userId) return;
    isTyping = true;
    set(ref(db, `typing/${userId}`), true);
    typingTimeout = setTimeout(stopTyping, 3000);
  }

  function stopTyping() {
    if (!isTyping || !userId) return;
    isTyping = false;
    remove(ref(db, `typing/${userId}`));
    if (typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = null;
    textInput.placeholder = "Type a message...";
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // setupTypingListener, setupMessageListener, setupPresence, setupUserListener, openProfileModal,
  // openPasskeyModal, checkUsernameUnique, verifyPasskey, savePasskey, verifyUserPasskey,
  // event listeners, emoji picker, file handling, etc.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // (all these functions remain unchanged â€“ only write operations have guards)

  async function init() {
    try {
      if (loadNightMode()) document.body.classList.add("night");
      currentUser = loadUserFromLocal();
      sessionVerified = loadSessionVerified();

      if (!currentUser) {
        openProfileModal();
        return;
      }

      // Wait for Firebase Authentication to give us a real uid
      if (!userId) {
        await new Promise(resolve => {
          const unsubscribe = onAuthStateChanged(auth, u => {
            if (u) {
              unsubscribe();
              resolve();
            }
          });
        });
      }

      const userSnapshot = await get(ref(db, `users/${userId}`));
      const userData = userSnapshot.val();

      selectedAvatarUrl = userData?.avatar || maleAvatars[hashCode(currentUser.username + userId) % maleAvatars.length];
      currentUser.avatar = selectedAvatarUrl;
      currentUser.passkey = userData?.passkey;
      isPasskeySet = !!userData?.passkey;

      usersMap.set(userId, { username: currentUser.username, avatar: selectedAvatarUrl });

      if (sessionVerified && userData?.passkey && (await verifyPasskey(userId, loadPasskeyFromLocal()))) {
        isPasskeyVerified = true;
        showChatInterface();
      } else {
        openPasskeyModal("verify");
      }
    } catch (error) {
      console.error("Initialization failed:", error);
      passkeyError.textContent = "Failed to start: " + error.message;
      passkeyError.style.display = "block";
    }
  }

  init();

</script>
</body>
</html>
